name: AI PR Title Review

on:
  workflow_run:
    workflows: ["AI Title Suggestion Request"]
    types: [completed]

jobs:
  review:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      models: read

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pr-ai-metadata
          path: ./meta

      - name: Parse and validate input
        id: parse
        run: |
          TITLE=$(cat ./meta/title.txt | tr -d '' | head -c 72 | sed 's/[^[:print:]]//g')
          DIFF=$(cat ./meta/diff.txt | head -c 10000 | tr -d '\r\n')

          echo "pr_title=$TITLE" >> $GITHUB_OUTPUT
          echo "diff=$DIFF" >> $GITHUB_OUTPUT
          echo "pr_number=$(cat ./meta/PR.txt)" >> $GITHUB_OUTPUT

      - name: AI Title Evaluation
        id: ai
        uses: actions/ai-inference@v1.1.0
        with:
          model: openai/gpt-4o
          system-prompt-file: ".github/config/system-prompt.txt"
          prompt: |
            Based on the following input data:

            {
              "diff": "${{ steps.parse.outputs.diff }}",
              "pr_title": "${{ steps.parse.outputs.pr_title }}"
            }

            Respond ONLY with valid JSON in the format:
            {
              "improved_rating": <0-10>,
              "improved_ai_title_rating": <0-10>,
              "improved_title": "<ai generated title>"
            }

      - name: Parse AI Response
        id: validate
        run: |
          echo '${{ steps.ai.outputs.response }}' > response.json

          jq -e '(
            (keys | sort) == ["improved_ai_title_rating", "improved_rating", "improved_title"] and
            (.improved_rating | type == "number") and
            (.improved_ai_title_rating | type == "number") and
            (.improved_title | type == "string")
          )' response.json || {
            echo "Invalid AI response" >&2; cat response.json >&2; exit 1;
          }

          COMMENT=$(cat <<EOF
          ## 🤖 AI PR Title Suggestion

          **PR-Title Rating**: $(jq -r '.improved_rating' response.json)/10

          ### ⬇️ Suggested Title (copy & paste):

          \`\`\`
          $(jq -r '.improved_title' response.json)
          \`\`\`

          ---
          *Generated by GitHub Models AI*
          EOF
          )
          echo "$COMMENT" > comment.md

      - name: Post Suggestion Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = Number(fs.readFileSync('./meta/PR.txt'));
            const body = fs.readFileSync('comment.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
